<html>
  <head>
    <title>AR CAKE</title>
    <meta
      name="viewport"
      content="width=device-width, viewport-fit=cover, shrink-to-fit=no"
    />
    <style>
      * {
        margin: 0;
        padding: 0;
      }

      .wrapper {
        position: relative;
        overflow: hidden;
      }
    </style>
  </head>
  <body>
    <div class="wrapper">
      <canvas></canvas>
    </div>
    <!--❶ three.jsとAR.jsを読み込む-->
    <script src="https://unpkg.com/three@0.127.0/build/three.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/3.3.3/three.js/build/ar.js"></script>
    <script async>
      const renderer = new THREE.WebGLRenderer({
        canvas: document.querySelector("canvas"),
        antialias: true,
        alpha: true,
      });
      const camera = new THREE.PerspectiveCamera();
      const scene = new THREE.Scene();
      const markerRoot = new THREE.Group();
      const arToolkitContext = new THREEx.ArToolkitContext({
        cameraParametersUrl: "./camera_para.dat", // ❷ camera.datを読み込む
        detectionMode: "mono",
      });
      const arToolkitSource = new THREEx.ArToolkitSource({
        sourceType: "webcam",
      });
      const arMarkerControl = new THREEx.ArMarkerControls(
        arToolkitContext,
        markerRoot,
        {
          type: "pattern",
          patternUrl: "./pattern-hiro.patt", // hello markerのpattを読み込む
        }
      );

      renderer.setSize(window.innerWidth, window.innerHeight);

      window.addEventListener("resize", handleResize, {
        passive: true,
      });

      arToolkitContext.init(() => {
        camera.projectionMatrix.copy(arToolkitContext.getProjectionMatrix());
      });

      arToolkitSource.init(() => {
        document
          .querySelector(".wrapper")
          .appendChild(arToolkitSource.domElement); // ❹ videoタグを.wrapper配下に移動させる
        setTimeout(handleResize, 400); // ❺ リサイズイベントを一度発火させる
      });

      scene.add(markerRoot);

      // ライトを作成
      const ambientLight = new THREE.AmbientLight(0xffffff, 0.5); // 環境光
      scene.add(ambientLight);

      const directionalLight = new THREE.DirectionalLight(0xffffff, 1); // 平行光
      directionalLight.position.set(1, 1, 1);
      scene.add(directionalLight);

      const cakeGeometry = new THREE.CylinderGeometry(1, 0.8, 1, 32);
      const cakeMaterial = new THREE.MeshStandardMaterial({ color: 0xffffff }); // 白色の材質

      const cake = new THREE.Mesh(cakeGeometry, cakeMaterial);
      cake.position.set(0, 0.5, 0);

      scene.add(cake); // シーンにケーキを追加

      markerRoot.add(cake);

      renderer.setAnimationLoop((delta) => {
        if (arToolkitSource.ready) {
          arToolkitContext.update(arToolkitSource.domElement);
        }

        renderer.render(scene, camera);
      });

      function handleResize() {
        if (arToolkitSource.ready) {
          arToolkitSource.onResize();
          arToolkitSource.copySizeTo(renderer.domElement);
        }

        renderer.setPixelRatio(window.devicePixelRatio);
      }
    </script>
  </body>
</html>
